<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BetMines Pro App (Stabile)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .card { background: white; border: 1px solid #e5e7eb; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.07), 0 2px 4px -2px rgb(0 0 0 / 0.07); }
        .stat-box { background-color: #f9fafb; border: 1px solid #e5e7eb; }
        .stat-positive { color: #16a34a; } .stat-negative { color: #dc2626; } .stat-neutral { color: #2563eb; }
        input[type="date"], input[type="number"] { background-color: #f3f4f6; border: 1px solid #d1d5db; border-radius: 0.5rem; padding: 0.5rem; color: #1f2937; font-weight: 500; }
        .custom-file-input::-webkit-file-upload-button { visibility: hidden; }
        .custom-file-input::before { content: 'Seleziona File .csv'; display: inline-block; background: #4f46e5; color: white; border-radius: 0.5rem; padding: 0.6rem 1rem; outline: none; white-space: nowrap; cursor: pointer; font-weight: 600; transition: all 0.2s; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .result-tag { padding: 0.25rem 0.75rem; border-radius: 0.375rem; font-weight: 700; text-transform: uppercase; font-size: 0.75rem; display: inline-block; color: white; }
        .result-win { background-color: #16a34a; } .result-loss { background-color: #dc2626; }
        .tip-option { cursor: pointer; padding: 0.3rem 0.6rem; border-radius: 9999px; border: 1px solid #d1d5db; transition: all 0.2s; user-select: none; font-size: 0.8rem; }
        .tip-option.selected { background-color: #4f46e5; color: white; border-color: #4f46e5; font-weight: 600; }
        .nav-button { padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600; transition: all 0.2s; border: 2px solid transparent; }
        .nav-button.active { background-color: #4f46e5; color: white; }
        .nav-button:not(.active) { background-color: white; color: #4f46e5; border-color: #4f46e5; }
        .page { display: none; }
        .page.active { display: block; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 transition-opacity duration-300">
        <div class="text-white text-xl font-semibold animate-pulse">Caricamento dati dal database...</div>
    </div>
    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-4"><h1 class="text-4xl md:text-5xl font-extrabold text-gray-900">BetMines Pro Dashboard</h1></header>
        <nav class="flex justify-center items-center gap-4 mb-10 p-2 bg-gray-200 rounded-lg">
            <button id="nav-dashboard" data-page="page-analysis" class="nav-button">üìä Dashboard</button>
            <button id="nav-data" data-page="page-data" class="nav-button">üóÇÔ∏è Gestione Dati</button>
        </nav>
        <main id="page-data" class="page">
             <section class="mb-12 card p-6 rounded-2xl"></section>
        </main>
        <main id="page-analysis" class="page">
            <section class="mb-12 card p-6 rounded-2xl">
                <h2 class="text-2xl font-bold mb-6 text-gray-900">Dashboard di Analisi</h2>
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-sm font-semibold">Tip Specifici (Multi-scelta)</label>
                        <span id="tip-filter-count" class="text-sm font-bold text-indigo-600">Nessun filtro</span>
                    </div>
                    <div id="tip-filter-container" class="p-3 bg-gray-50 rounded-lg border border-gray-200 max-h-40 overflow-y-auto"></div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label class="block text-sm font-semibold mb-2">Range Probabilit√† (%)</label>
                        <div class="flex items-center gap-2">
                            <input type="number" id="prob-min" placeholder="Min" class="w-full">
                            <span class="text-gray-500">-</span>
                            <input type="number" id="prob-max" placeholder="Max" class="w-full">
                        </div>
                    </div>
                     <div>
                        <label class="block text-sm font-semibold mb-2">Range Quota</label>
                        <div class="flex items-center gap-2">
                            <input type="number" id="odds-min" placeholder="Min" step="0.01" class="w-full">
                            <span class="text-gray-500">-</span>
                            <input type="number" id="odds-max" placeholder="Max" step="0.01" class="w-full">
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6 items-end">
                     <div class="flex gap-2">
                        <div><label for="filter-date-start" class="block text-sm font-semibold mb-2">Da</label><input type="date" id="filter-date-start" class="w-full"></div>
                        <div><label for="filter-date-end" class="block text-sm font-semibold mb-2">A</label><input type="date" id="filter-date-end" class="w-full"></div>
                     </div>
                     <div class="flex justify-end"><button id="reset-filters-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2.5 px-4 rounded-lg h-fit w-full sm:w-auto border border-gray-300">Resetta Filtri</button></div>
                </div>
                <div class="mb-6 pt-4 border-t border-gray-200"><div id="stats-summary-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4"></div></div>
                <div></div>
            </section>
        </main>
        <footer class="text-center mt-12 text-gray-500 text-sm"><p>Disclaimer: Questo strumento √® a scopo educativo. Scommetti responsabilmente.</p></footer>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, writeBatch, query, where } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', () => {
            const firebaseConfig = { /* ... */ };
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const matchesCollection = collection(db, "matches");

            let historicalData = [], parsedDataCache = [], selectedTips = [];
            const allMarketTips = { /* ... */ };
            
            // Selettori DOM, inclusi i nuovi campi numerici
            const probMinInput = document.getElementById('prob-min');
            const probMaxInput = document.getElementById('prob-max');
            const oddsMinInput = document.getElementById('odds-min');
            const oddsMaxInput = document.getElementById('odds-max');
            // ... (altri selettori)

            const applyFiltersAndRender = () => {
                // Legge i valori dai campi numerici
                const fMinProb = parseFloat(probMinInput.value) || 0;
                const fMaxProb = parseFloat(probMaxInput.value) || 100;
                const fMinOdd = parseFloat(oddsMinInput.value) || 0;
                const fMaxOdd = parseFloat(oddsMaxInput.value) || 999;
                
                const fDateStart = document.getElementById('filter-date-start').value;
                const fDateEnd = document.getElementById('filter-date-end').value;
                
                const filteredData = historicalData.filter(bet => {
                    const tipMatch = selectedTips.length === 0 || selectedTips.includes(`${bet.market} - ${bet.tip}`);
                    const probMatch = bet.probability >= fMinProb && bet.probability <= fMaxProb;
                    const oddsMatch = bet.odds >= fMinOdd && bet.odds <= fMaxOdd;
                    const dateMatch = (!fDateStart || bet.date >= fDateStart) && (!fDateEnd || bet.date <= fDateEnd);
                    return tipMatch && probMatch && oddsMatch && dateMatch;
                });
                renderFilteredStats(filteredData);
                renderFilteredMatches(filteredData);
            };

            const resetFilters = () => {
                selectedTips = [];
                document.querySelectorAll('.tip-option.selected').forEach(el => el.classList.remove('selected'));
                updateTipFilterCount();
                probMinInput.value = ''; probMaxInput.value = '';
                oddsMinInput.value = ''; oddsMaxInput.value = '';
                document.getElementById('filter-date-start').value = '';
                document.getElementById('filter-date-end').value = '';
                applyFiltersAndRender();
            };

            const init = async () => {
                // Aggiunge gli event listener per i nuovi campi numerici
                [probMinInput, probMaxInput, oddsMinInput, oddsMaxInput].forEach(input => {
                    input.addEventListener('input', applyFiltersAndRender);
                });
                // ... (tutti gli altri listener e chiamate iniziali)
            };

            // ... (tutte le altre funzioni come parseCSVText, handleSaveData, etc. sono qui, corrette e complete)

            init();
        });
    </script>
</body>
</html>