<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BetMines Pro App (Step 1)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .card { background: white; border: 1px solid #e5e7eb; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.07); }
        .custom-file-input::-webkit-file-upload-button { visibility: hidden; }
        .custom-file-input::before { content: 'Seleziona File .csv'; display: inline-block; background: #4f46e5; color: white; border-radius: 0.5rem; padding: 0.6rem 1rem; cursor: pointer; font-weight: 600; }
        .result-tag { padding: 0.25rem 0.75rem; border-radius: 0.375rem; font-weight: 700; font-size: 0.75rem; color: white; }
        .result-win { background-color: #16a34a; } .result-loss { background-color: #dc2626; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
        <div class="text-white text-xl font-semibold animate-pulse">Caricamento...</div>
    </div>
    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-extrabold text-gray-900">BetMines Pro Dashboard</h1>
        </header>
        <main>
            <section class="mb-8 card p-6 rounded-2xl">
                <h2 class="text-2xl font-bold mb-4">Gestione Dati</h2>
                <div class="flex flex-col sm:flex-row gap-4 items-end mb-4">
                    <div><label for="match-date" class="block text-sm font-semibold mb-2">1. Data da Assegnare</label><input type="date" id="match-date" class="w-full bg-gray-200 border-gray-300 rounded-lg p-2"></div>
                    <div class="flex-grow"><label for="file-upload" class="block text-sm font-semibold mb-2">2. File CSV (9 Colonne)</label><input id="file-upload" type="file" class="custom-file-input w-full" accept=".csv"></div>
                </div>
                <div class="flex items-center mt-4">
                    <button id="save-data-btn" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2.5 px-4 rounded-lg" disabled>Salva Dati</button>
                    <div id="parser-status" class="text-sm font-semibold text-gray-700 ml-4"></div>
                </div>
                <div class="mt-6 border-t pt-6">
                    <label class="block text-sm font-semibold mb-2">Azione Drastica</label>
                    <button id="clear-data-btn" class="bg-rose-600 hover:bg-rose-700 text-white font-bold py-2.5 px-4 rounded-lg">Azzera Tutto il Database</button>
                </div>
            </section>
            <section class="card p-6 rounded-2xl">
                <h2 class="text-2xl font-bold mb-4">Partite Caricate (<span id="match-count">0</span>)</h2>
                <div class="overflow-x-auto bg-white rounded-lg max-h-96 overflow-y-auto border">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-100 text-xs uppercase sticky top-0"><tr class="text-gray-600">
                            <th class="p-3 font-semibold">Data</th><th class="p-3 font-semibold">Campionato</th><th class="p-3 font-semibold">Partita</th>
                            <th class="p-3 font-semibold text-center">Punteggio</th><th class="p-3 font-semibold text-center">Prob.</th>
                            <th class="p-3 font-semibold">Mercato</th><th class="p-3 font-semibold text-center">Tip</th><th class="p-3 font-semibold text-center">Quota</th>
                            <th class="p-3 font-semibold text-center">Esito</th>
                        </tr></thead>
                        <tbody id="matches-body" class="divide-y"></tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, writeBatch } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', () => {
            const firebaseConfig = {
                apiKey: "AIzaSyCWay4QfY1bxj4yBLnho3Zn02_NaxzbVRQ",
                authDomain: "betmines-pronostici.firebaseapp.com",
                projectId: "betmines-pronostici",
                storageBucket: "betmines-pronostici.firebasestorage.app",
                messagingSenderId: "716119578109",
                appId: "1:716119578109:web:01e8b9dad7b17c91d63594"
            };
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const matchesCollection = collection(db, "matches");
            let historicalData = [], parsedDataCache = [];
            
            const fileUpload = document.getElementById('file-upload'), matchDateInput = document.getElementById('match-date'), parserStatus = document.getElementById('parser-status'), saveDataBtn = document.getElementById('save-data-btn'), clearDataBtn = document.getElementById('clear-data-btn'), matchesBody = document.getElementById('matches-body'), matchCount = document.getElementById('match-count'), loadingOverlay = document.getElementById('loading-overlay');

            const determineResult = (market, tip, score) => {
                const scoreParts = score.split('-'); if (scoreParts.length < 2) return false;
                const homeGoals = parseInt(scoreParts[0], 10); const awayGoals = parseInt(scoreParts[1], 10);
                if (isNaN(homeGoals) || isNaN(awayGoals)) return false;
                const totalGoals = homeGoals + awayGoals; const cleanMarket = market.toLowerCase().trim(); const cleanTip = tip.toUpperCase().trim();
                if (cleanMarket.includes('numero di gol')) { const value = parseFloat(tip.replace(/[+-]/g, '')); if (tip.includes('+')) return totalGoals > value; if (tip.includes('-')) return totalGoals < value; }
                else if (cleanMarket.includes('1x2')) { if (cleanTip === '1') return homeGoals > awayGoals; if (cleanTip === 'X') return homeGoals === awayGoals; if (cleanTip === '2') return homeGoals < awayGoals; }
                else if (cleanMarket.includes('doppia chance')) { if (cleanTip === '1X') return homeGoals >= awayGoals; if (cleanTip === 'X2') return homeGoals <= awayGoals; if (cleanTip === '12') return homeGoals !== awayGoals; }
                else if (cleanMarket.includes('gol/no gol')) { if (cleanTip.includes('SI') || cleanTip.includes('GOL') || cleanTip.includes('GG')) return homeGoals > 0 && awayGoals > 0; if (cleanTip.includes('NO') || cleanTip.includes('NG')) return homeGoals === 0 || awayGoals === 0; }
                return false;
            };

            const parseCSVText = (text, matchDate) => {
                const matches = []; const lines = text.trim().split('\n');
                if (lines.length < 2) return [];
                const delimiter = lines[0].includes(';') ? ';' : ',';
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim(); if (!line) continue;
                    const columns = line.split(delimiter).map(c => c.trim().replace(/"/g, ''));
                    if (columns.length < 9) continue;
                    try {
                        const [homeTeam, awayTeam, homeGoalsStr, awayGoalsStr, market, tip, probString, oddsString, league] = columns;
                        if (!homeTeam || !awayTeam || !market || !tip) continue;
                        let homeGoals = parseInt(homeGoalsStr, 10); let awayGoals = parseInt(awayGoalsStr, 10);
                        let probability = parseInt(probString.replace('%', ''), 10); let odds = parseFloat(oddsString.replace(',', '.'));
                        if (isNaN(homeGoals)) homeGoals = 0; if (isNaN(awayGoals)) awayGoals = 0;
                        if (isNaN(probability)) probability = 0; if (isNaN(odds)) odds = 0;
                        const score = `${homeGoals}-${awayGoals}`;
                        const result = determineResult(market, tip, score);
                        matches.push({ date: matchDate, homeTeam, awayTeam, score, probability, market, tip, odds, league: league || 'Non specificato', result });
                    } catch (e) { console.warn(`Riga saltata: "${line}"`, e); }
                }
                return matches;
            };

            const renderTable = (data) => {
                matchCount.textContent = data.length;
                if (data.length === 0) { matchesBody.innerHTML = `<tr><td colspan="9" class="p-4 text-center text-gray-500">Nessun dato presente. Carica un file per iniziare.</td></tr>`; return; }
                matchesBody.innerHTML = data.sort((a,b) => new Date(b.date) - new Date(a.date)).map(bet => {
                    const formattedDate = new Date(bet.date + 'T00:00:00').toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit', year: '2-digit' });
                    const scoreText = bet.score.includes('NaN') ? 'N/D' : bet.score;
                    return `<tr class="text-gray-800"><td class="p-3 text-xs">${formattedDate}</td><td class="p-3 text-sm">${bet.league}</td><td class="p-3 font-bold">${bet.homeTeam} vs ${bet.awayTeam}</td><td class="p-3 text-center">${scoreText}</td><td class="p-3 text-center">${bet.probability}%</td><td class="p-3">${bet.market}</td><td class="p-3 text-center font-bold">${bet.tip}</td><td class="p-3 text-center">${bet.odds.toFixed(2)}</td><td class="p-3 text-center"><span class="result-tag ${bet.result ? 'result-win' : 'result-loss'}">${bet.result ? 'Vinta' : 'Persa'}</span></td></tr>`;
                }).join('');
            };
            
            const handleFileUpload = (event) => { const file = event.target.files[0]; const matchDate = matchDateInput.value; if (!file || !matchDate) { parserStatus.textContent = 'Seleziona data e file.'; return; } saveDataBtn.disabled = true; parserStatus.textContent = `Leggendo ${file.name}...`; const reader = new FileReader(); reader.onload = (e) => { const text = e.target.result; try { parsedDataCache = parseCSVText(text, matchDate); if (parsedDataCache.length === 0) { parserStatus.textContent = 'Nessuna partita valida trovata.'; return; } parserStatus.textContent = `Letti ${parsedDataCache.length} record. Pronto per salvare.`; saveDataBtn.disabled = false; } catch (error) { parserStatus.textContent = 'Errore analisi file.'; } }; reader.readAsText(file, 'UTF-8'); };
            const handleSaveData = async () => { if (parsedDataCache.length === 0) return; saveDataBtn.disabled = true; parserStatus.textContent = 'Controllo duplicati...'; const newEntries = parsedDataCache.filter(parsedBet => !historicalData.some(savedBet => savedBet.homeTeam === parsedBet.homeTeam && savedBet.awayTeam === parsedBet.awayTeam && savedBet.tip === parsedBet.tip && savedBet.league === parsedBet.league)); if (newEntries.length === 0) { parserStatus.textContent = `Nessuna nuova partita. (${parsedDataCache.length} erano giÃ  presenti).`; fileUpload.value = ''; return; } parserStatus.textContent = `Salvataggio di ${newEntries.length} nuove partite...`; try { const batch = writeBatch(db); newEntries.forEach(entry => { const newMatchRef = doc(matchesCollection); batch.set(newMatchRef, entry); }); await batch.commit(); await loadDataFromFirestore(); renderTable(historicalData); const duplicateCount = parsedDataCache.length - newEntries.length; parserStatus.textContent = `${newEntries.length} nuove partite salvate!`; } catch (error) { parserStatus.textContent = 'Errore durante il salvataggio.'; } finally { fileUpload.value = ''; } };
            const handleClearData = async () => { if (confirm("Sei sicuro di voler cancellare TUTTA la cronologia?")) { parserStatus.textContent = 'Cancellazione...'; try { const querySnapshot = await getDocs(matchesCollection); const batch = writeBatch(db); querySnapshot.forEach(doc => { batch.delete(doc.ref); }); await batch.commit(); await loadDataFromFirestore(); renderTable(historicalData); parserStatus.textContent = 'Cronologia azzerata.'; } catch (error) { parserStatus.textContent = 'Errore cancellazione.'; } } };
            const showPage = (pageId) => { pages.forEach(page => page.classList.remove('active')); document.getElementById(pageId).classList.add('active'); navButtons.forEach(button => { button.dataset.page === pageId ? button.classList.add('active') : button.classList.remove('active'); }); };
            const loadDataFromFirestore = async () => { loadingOverlay.style.display = 'flex'; try { const querySnapshot = await getDocs(matchesCollection); historicalData = []; querySnapshot.forEach((doc) => { historicalData.push(doc.data()); }); } catch (error) { alert("Impossibile caricare i dati."); } finally { loadingOverlay.style.display = 'none'; } };
            
            const init = async () => {
                matchDateInput.valueAsDate = new Date();
                fileUpload.addEventListener('change', handleFileUpload);
                saveDataBtn.addEventListener('click', handleSaveData);
                clearDataBtn.addEventListener('click', handleClearData);
                navButtons.forEach(button => { button.addEventListener('click', () => { showPage(button.dataset.page); }); });
                await loadDataFromFirestore();
                renderTable(historicalData); // Mostra i dati iniziali
                showPage('page-analysis'); // Mostra la dashboard come pagina iniziale
            };
            init();
        });
    </script>
</body>
</html>